@{
    Layout = "~/Views/Shared/_AdminLayout.cshtml";
}

<div class="page-header">
    <h4 class="page-title">Article Management</h4>
    <ul class="breadcrumbs">
        <li class="nav-home">
            <a href="#">
                <i class="icon-home"></i>
            </a>
        </li>
        <li class="separator">
            <i class="icon-arrow-right"></i>
        </li>
        <li class="nav-item">
            <a href="#">Article Management</a>
        </li>
    </ul>
</div>

<div class="col-md-12">
    <div class="card">
        <div class="card-header">
            <div class="d-flex align-items-center">
                <h4 class="card-title">Articles</h4>
                <button class="btn btn-primary btn-round ms-auto" data-bs-toggle="modal" data-bs-target="#addArticleModal" onclick="openAddModal()">
                    <i class="fa fa-plus"></i> Add Article
                </button>
            </div>
        </div>

        <div class="card-body">
            <div class="table-responsive">
                <table id="articleTable" class="display table table-striped table-hover">
                    <thead>
                        <tr>
                            <th>Article ID</th>
                            <th>Title</th>
                            <th>Category</th>
                            <th style="width: 10%">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var article in Model)
                        {
                            <tr id="article-row-@article.Id">
                                <td>@article.Id</td>
                                <td>@article.Title</td>
                                <td>@article.Category?.CategoryName</td>
                                <td>
                                    <div class="form-button-action">
                                        <button type="button" class="btn btn-link btn-primary btn-lg btn-edit" data-id="@article.Id">
                                            <i class="fa fa-edit"></i>
                                        </button>
                                        <button class="btn btn-link btn-danger btn-delete" data-id="@article.Id">
                                            <i class="fa fa-times"></i>
                                        </button>
                                    </div>
                                </td>

                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Add/Edit Article Modal -->
<!-- Add Article Modal -->
<div class="modal fade" id="addArticleModal" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header border-0">
                <h5 class="modal-title">Add Article</h5>
                <button type="button" class="close" data-bs-dismiss="modal" aria-label="Close">
                    <span>&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="addArticleForm">
                    @Html.AntiForgeryToken()

                    <div class="form-group form-group-default">
                        <label>Article Title</label>
                        <input id="addArticleTitle" name="Title" type="text" class="form-control" placeholder="Enter article title" required />
                    </div>

                    <div class="form-group form-group-default">
                        <label>Content</label>
                        <textarea id="addArticleContent" name="Content" class="form-control" placeholder="Enter article content" required></textarea>
                    </div>

                    <div class="form-group form-group-default">
                        <label>Category</label>
                        <select id="addArticleCategory" name="CatId" class="form-control" required>
                            <option value="" disabled selected>Select a category</option>
                            @foreach (var category in ViewBag.Categories)
                            {
                                <option value="@category.CategoryId">@category.CategoryName</option>
                            }
                        </select>
                    </div>

                    <div class="form-group form-group-default">
                        <label>User</label>
                        <select id="addArticleUser" name="UserId" class="form-control" required>
                            <option value="" disabled selected>Select a user</option>
                            @foreach (var user in ViewBag.Users)
                            {
                                <option value="@user.Id">@user.Name</option>
                            }
                        </select>
                    </div>

                    <div class="form-group form-group-default">
                        <label>Image URL</label>
                        <input id="addArticleImageUrl" name="ImageUrl" type="text" class="form-control" placeholder="Enter image URL" />
                    </div>

                    <div class="form-group form-group-default">
                        <label>Publish Date</label>
                        <input id="addArticlePublishDate" name="PublishDate" type="date" class="form-control" placeholder="Enter publish date" required />
                    </div>

                </form>
            </div>
            <div class="modal-footer border-0">
                <button type="button" class="btn btn-primary" id="addArticleButton">Add</button>
                <button type="button" class="btn btn-danger" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Edit Article Modal -->
<div class="modal fade" id="editArticleModal" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header border-0">
                <h5 class="modal-title">Edit Article</h5>
                <button type="button" class="close" data-bs-dismiss="modal" aria-label="Close">
                    <span>&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="editArticleForm">
                    @Html.AntiForgeryToken()
                    <input type="hidden" id="editArticleId" name="Id" />

                    <div class="form-group form-group-default">
                        <label>Article Title</label>
                        <input id="editArticleTitle" name="Title" type="text" class="form-control" required />
                    </div>

                    <div class="form-group form-group-default">
                        <label>Content</label>
                        <textarea id="editArticleContent" name="Content" class="form-control" required></textarea>
                    </div>

                    <div class="form-group form-group-default">
                        <label>Category</label>
                        <select id="editArticleCategory" name="CatId" class="form-control" required>
                            <option value="" disabled>Select a category</option>
                            @foreach (var category in ViewBag.Categories)
                            {
                                <option value="@category.CategoryId">@category.CategoryName</option>
                            }
                        </select>
                    </div>

                    <div class="form-group form-group-default">
                        <label>User</label>
                        <select id="editArticleUser" name="UserId" class="form-control" required>
                            <option value="" disabled>Select a user</option>
                            @foreach (var user in ViewBag.Users)
                            {
                                <option value="@user.Id">@user.Name</option>
                            }
                        </select>
                    </div>

                    <div class="form-group form-group-default">
                        <label>Image URL</label>
                        <input id="editArticleImageUrl" name="ImageUrl" type="text" class="form-control" />
                    </div>

                    <div class="form-group form-group-default">
                        <label>Publish Date</label>
                        <input id="editArticlePublishDate" name="PublishDate" type="date" class="form-control" required />
                    </div>
                </form>
            </div>
            <div class="modal-footer border-0">
                <button type="button" class="btn btn-primary" id="saveEditArticleButton">Save</button>
                <button type="button" class="btn btn-danger" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Script at the bottom of the page -->
<script>
    $(document).ready(function () {
        var currentArticleId = null;

        // Open the modal for adding a new article
        function openAddModal() {
            currentArticleId = null;  // Set to add mode
            resetAddArticleForm();  // Reset the form fields
            $('#addArticleButton').text('Add Article');  // Change button text to 'Add'
            $('#addArticleModal').modal('show');  // Show the modal
        }

        // Open the modal for editing an article
        function editArticle(articleId) {
            currentArticleId = articleId;  // Set the current article ID
            resetEditArticleForm();  // Reset the form before populating data

            // Fetch article data using AJAX and populate the form
            $.get('@Url.Action("GetArticle", "Admin")', { id: articleId }, function (response) {
                if (response.success) {
                    // Populate the form with article data
                    $('#editArticleId').val(response.article.Id);
                    $('#editArticleTitle').val(response.article.Title);
                    $('#editArticleContent').val(response.article.Content);
                    $('#editArticleCategory').val(response.article.CatId);
                    $('#editArticleUser').val(response.article.UserId);
                    $('#editArticleImageUrl').val(response.article.ImageUrl);
                    $('#editArticlePublishDate').val(response.article.PublishDate.split('T')[0]);  // Format date

                    $('#saveEditArticleButton').text('Save Changes');  // Change button text to 'Save'
                    $('#editArticleModal').modal('show');  // Show the modal
                } else {
                    alert('Failed to fetch article details.');
                }
            }).fail(function () {
                alert('Error fetching article data.');
            });
        }

        // Submit Add Article form
        $('#addArticleButton').on('click', function () {
            var articleData = {
                Title: $('#addArticleTitle').val(),
                Content: $('#addArticleContent').val(),
                CatId: $('#addArticleCategory').val(),
                UserId: $('#addArticleUser').val(),
                ImageUrl: $('#addArticleImageUrl').val(),
                PublishDate: $('#addArticlePublishDate').val()
            };

            $.ajax({
                url: '@Url.Action("AddArticle", "Admin")',
                type: 'POST',
                data: articleData,
                success: function (response) {
                    if (response.success) {
                        $('#addArticleModal').modal('hide');  // Close the modal
                        location.reload();  // Reload the page to reflect changes
                    } else {
                        alert('Failed to add article.');
                    }
                },
                error: function () {
                    alert('Error occurred while adding article.');
                }
            });
        });

        // Submit Edit Article form
        $('#saveEditArticleButton').on('click', function () {
            var articleData = {
                Id: $('#editArticleId').val(),
                Title: $('#editArticleTitle').val(),
                Content: $('#editArticleContent').val(),
                CatId: $('#editArticleCategory').val(),
                UserId: $('#editArticleUser').val(),
                ImageUrl: $('#editArticleImageUrl').val(),
                PublishDate: $('#editArticlePublishDate').val()
            };

            $.ajax({
                url: '@Url.Action("EditArticle", "Admin")',
                type: 'POST',
                data: articleData,
                success: function (response) {
                    if (response.success) {
                        $('#editArticleModal').modal('hide');  // Close the modal
                        location.reload();  // Reload the page to reflect changes
                    } else {
                        alert('Failed to update article.');
                    }
                },
                error: function () {
                    alert('Error occurred while updating article.');
                }
            });
        });

        // Use event delegation for dynamically generated elements (edit and delete buttons)
        $(document).on('click', '.btn-edit', function () {
            var articleId = $(this).data('id');
            editArticle(articleId);  // Call the edit function
        });

        $(document).on('click', '.btn-delete', function () {
            var articleId = $(this).data('id');
            deleteArticle(articleId);  // Call the delete function
        });

        // Delete Article
        function deleteArticle(articleId) {
            if (confirm('Are you sure you want to delete this article?')) {
                $.ajax({
                    url: '@Url.Action("DeleteArticle", "Admin")',
                    type: 'POST',
                    data: { id: articleId },
                    success: function (response) {
                        if (response.success) {
                            $('#article-row-' + articleId).fadeOut(500, function () {
                                $(this).remove();
                            });
                        } else {
                            alert('Failed to delete article.');
                        }
                    },
                    error: function () {
                        alert('Error occurred while deleting article.');
                    }
                });
            }
        }

        // Reset forms before displaying them
        function resetAddArticleForm() {
            $('#addArticleForm')[0].reset();  // Reset Add form
        }

        function resetEditArticleForm() {
            $('#editArticleForm')[0].reset();  // Reset Edit form
        }
    });



</script>
